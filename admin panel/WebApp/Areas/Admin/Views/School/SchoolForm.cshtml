@{
    ViewBag.Title = "School";
    Layout = "~/Areas/Admin/Views/Shared/_AfterLayout.cshtml";
}

<div ng-controller="ctrSchoolForm" class="wrapper">
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">School Details</h6>
        </div>
        <div class="card-body">
            <form>

                <div class="row">
                    <div class="col-lg-8 col-md-8 ">
                        <label for="exampleFormControlInput1">Name<lable style="color: red">&nbsp*</lable></label>
                        <input type="text" class="form-control" autocomplete="off" ng-model="ctrSchoolForm.schoolname" maxlength="100" required school autofocus ngmessage="Please enter the school Name">
                    </div>
                    <div class="col-lg-4 col-md-4 ">
                        @* <input type="checkbox" class="form-check-input" ng-model="ctrTeacherForm.isblockadmin">
        <label class="form-check-label" for="exampleCheck1">Block Admin</label>*@

                        <label for="exampleFormControlSelect1">Block<lable style="color: red">&nbsp*</lable></label>
                        <select ng-model="ctrSchoolForm.blockid" autocomplete="off" ng-options="x.blockid as x.blockname for x in BlockList" class="form-control" required autofocus ngmessage="Please select Block">
                        </select>
                        @*<select ng-model="ctrSchoolForm.blockid" autocomplete="off" ng-options="x.blockid as x.blockname for x in BlockList" ng-disabled="blockreadonly" class="form-control" required autofocus ngmessage="Please select Block">
                        </select>*@
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12 col-md-12 ">
                        <label for="exampleFormControlTextarea1">
                            Address
                            <lable style="color: red">&nbsp*</lable>
                        </label>
                        <textarea class="form-control" rows="3" autocomplete="off" ng-model="ctrSchoolForm.schooladdress" maxlength="500" required school autofocus ngmessage="Please enter the Address"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-4 col-md-4 ">
                        <label for="exampleFormControlSelect1">Country<lable style="color: red">&nbsp*</lable></label>
                        <select ng-model="ctrSchoolForm.countryid" autocomplete="off" ng-options="x.countryid as x.countryname for x in CountryList" ng-change="FilterState()" class="form-control" required school autofocus ngmessage="Please select Country">
                        </select>

                    </div>

                    <div class="col-lg-4 col-md-4 ">
                        <label for="exampleFormControlSelect1">State<lable style="color: red">&nbsp*</lable></label>
                        <select ng-model="ctrSchoolForm.stateid" autocomplete="off" ng-options="x.stateid as x.statename for x in StateList" ng-change="Filtercity()" ng-disabled="ctrSchoolForm.countryid==null" class="form-control" required school autofocus ngmessage="Please select City">
                        </select>
                    </div>

                    <div class="col-lg-4 col-md-4 ">
                        <label for="exampleFormControlSelect1">City<lable style="color: red">&nbsp*</lable></label>
                        <select ng-model="ctrSchoolForm.cityid" autocomplete="off" ng-options="x.cityid as x.cityname for x in CityList" ng-disabled="ctrSchoolForm.stateid==null" class="form-control" required school autofocus ngmessage="Please select City">
                        </select>

                    </div>
                </div>

                <div class="form-group">
                    <label for="exampleFormControlTextarea1">Remark </label>
                    <textarea class="form-control" rows="3" autocomplete="off" ng-model="ctrSchoolForm.remarks" required autofocus ngmessage="Please enter the remark"></textarea>
                </div>

                <div class="form-check">
                    <div class="row">
                        <div class="col-lg-4 col-md-4 ">
                            <input type="checkbox" class="form-check-input" ng-model="ctrSchoolForm.isactive">
                            <label class="form-check-label" for="exampleCheck1">Is Active</label>
                        </div>
                    </div>
                </div>

            </form>
        </div>


        <br>
        <hr class="style1">
        <div style="margin-top: 10px" class="form-group">
            <!-- Button -->

            <div class="col-sm-12 controls">
                <button id="btn-Save" class="btn btn-primary" ng-click="SaveUpdateDeleteSchool(false)">Save</button>
                <a id="btn-cancel" class="btn btn-secondary" href="@Url.Action("index", "School")">Cancel</a>
            </div>
        </div>
    </div>
</div>

<script>
    app.controller("ctrSchoolForm", function ($scope, $http, $q, $interval, $window, DTOptionsBuilder, DTColumnBuilder) {

        $scope.ctrSchoolForm = {};
        $scope.ctrSchoolForm.isactive = true;

        $scope.blockreadonly = true;

        $scope.getblockList = function () {
            var obj = {};
            obj.Search = "";
            $http.post('@Url.Action("Get_block_List", "block")', obj).then(
                           function (response) {
                              $scope.BlockList = _.where(response.data.aaData, { isactive: true });
                           },
                           function (err) {
                               var error = err;
                           });
        }
        $scope.getblockList();

        $scope.getCountryList = function () {
            $http.post('@Url.Action("Get_Country_List", "Country")').then(
                                  function (response) {
                                      $scope.CountryList = _.where(response.data.aaData, { isactive: true });;
                                      $scope.getStateList();
                                  },
                                  function (err) {
                                      var error = err;
                                  });
        }
        $scope.getCountryList();
        $scope.getStateList = function () {
            var obj = {};
            obj.Search = "";
            $http.post('@Url.Action("Get_State_List", "State")', obj).then(
                           function (response) {
                               $scope.StateList = _.where(response.data.aaData, { isactive: true });
                               $scope.TStateList = _.where(response.data.aaData, { isactive: true });

                               $scope.getCityList();
                           },
                           function (err) {
                               var error = err;
                           });
        }
        $scope.getCityList = function () {
            var obj = {};
            obj.Search = "";
            $http.post('@Url.Action("Get_city_List", "City")', obj).then(
                           function (response) {
                               $scope.CityList = _.where(response.data.aaData, { isactive: true });
                               $scope.TCityList = _.where(response.data.aaData, { isactive: true });
                           },
                           function (err) {
                               var error = err;
                           });
        }

        $scope.FilterState = function () {
            if ($scope.ctrSchoolForm.countryid > 0) {
                $scope.StateList = _.where($scope.TStateList, { countryid: $scope.ctrSchoolForm.countryid });
            }
            //else {
            //    showInfoToast("Please Select Country..");
            //}
        }
        $scope.Filtercity = function () {

            if ($scope.ctrSchoolForm.stateid > 0) {
                $scope.CityList = _.where($scope.TCityList, { stateid: $scope.ctrSchoolForm.stateid });
            } //else {
            //    showInfoToast("Please Select Country..");
            //}
        }
        var scid = parseInt(getQueryStringValue("id") != "" ? getQueryStringValue("id") : "0");
        if (scid > 0) {
            $scope.getSchoolList = function () {

                var scid = parseInt(getQueryStringValue("id") != "" ? getQueryStringValue("id") : "0");
                var obj = {};
                obj.Search = " and s.schoolid=" + scid;

                $http.post('@Url.Action("Get_School_List", "School")', obj).then(
                                            function (response) {
                                                $scope.ctrSchoolForm = response.data.aaData[0];

                                                //debugger
                                                //$scope.blockreadonly = response.data.aaData[0].blockid == 1 ? false : true;


                                                $scope.FilterState()
                                                $scope.Filtercity()

                                            },
                                            function (err) {
                                                var error = err;
                                            });
            }
            $scope.getSchoolList();
        }

        $scope.SaveUpdateDeleteSchool = function (Delete) {
            if (!ValidateRequired("school")) {
                return;
            }
            var obj = {};
            obj.sc = $scope.ctrSchoolForm;
            obj.isDelete = Delete;

            $http.post('@Url.Action("SaveUpdate_Delete_School", "School")', obj).then(
                           function (response) {
                               if (response.data.aaData == 1) {
                                   showSuccessToast("Data Saved Sucessfully");
                                   setTimeout(window.location.href = "@Url.Action("Index", "School")", 1000)
                               } else if (response.data.aaData == 2) {
                                   showInfoToast("Already exist School Name...");
                               }
                               else {
                                   showWarningToast("Something went wrong.Please Try Again..")
                               };
                           },
                           function (err) {
                               var error = err;
                           });
        }

    });

</script>


