@{
    ViewBag.Title = "Subject";
    Layout = "~/Areas/Admin/Views/Shared/_AfterLayout.cshtml";
}

<div ng-controller="ctrSubjectForm" class="wrapper">
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Subject Details</h6>
        </div>
        <div class="card-body">
            <form>
                <div class="row">
                    <div class="col-lg-12 col-md-12 ">
                        <label for="exampleFormControlInput1">Name<lable style="color: red">&nbsp*</lable></label>
                        <input type="text" class="form-control" autocomplete="off" ng-model="ctrSubjectForm.subjectname" maxlength="50" required subject autofocus ngmessage="Please enter the subject Name">
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6 col-md-6 ">
                        <label for="exampleFormControlSelect1">Class Level<lable style="color: red">&nbsp*</lable></label>
                        <div ng-dropdown-multiselect="" options="Classdata" selected-model="ClassSelectmodel" extra-settings="setting2"></div>

                    </div>
                </div>
                <div class="form-group">
                    <label for="exampleFormControlTextarea1">Remark </label>
                    <textarea class="form-control" rows="3" autocomplete="off" ng-model="ctrSubjectForm.remarks" required autofocus ngmessage="Please enter the remark"></textarea>
                </div>

                <div class="form-check">
                    <div class="row">
                        <div class="col-lg-4 col-md-4 ">
                            <input type="checkbox" class="form-check-input" ng-model="ctrSubjectForm.isactive">
                            <label class="form-check-label" for="exampleCheck1">Is Active</label>

                        </div>

                    </div>
                </div>
            </form>
        </div>
        <hr class="style1">
        <div style="margin-top: 10px" class="form-group">
            <!-- Button -->

            <div class="col-sm-12 controls">
                <button id="btn-Save" href="javscript:void(0)" class="btn btn-primary" ng-click="SaveUpdateDeleteSubject(false)">Save</button>
                <a id="btn-cancel" class="btn btn-secondary" href="@Url.Action("index", "Subject")">Cancel</a>
            </div>
        </div>
    </div>
</div>

<script>
    app.controller("ctrSubjectForm", function ($scope, $http, $q, $interval, $window, DTOptionsBuilder, DTColumnBuilder) {

        $scope.ctrSubjectForm = {};
        $scope.ctrSubjectForm.isactive = true;

        $scope.ClassSelectmodel = [];

        $scope.example2settings = {
            displayProp: 'id'
        };
        $scope.setting2 = {
            scrollableHeight: '200px',
            scrollable: true,
            enableSearch: false
        };

        $scope.getClassList = function () {
            var obj = {};
            obj.Search = "";
            $http.post('@Url.Action("Get_Class_List", "ClassLevel")', obj).then(
                           function (response) {
                               //   $scope.ClassLevelList = response.data.aaData;
                               $scope.ClassLevelList = _.where(response.data.aaData, { isactive: true });

                               $scope.Classdata = _.map(_.where($scope.ClassLevelList),
                                    function (person) {
                                        return { id: person.classid, label: person.classlevelname };
                                    }
                                );
                           },
                           function (err) {
                               var error = err;
                           });
        }
        $scope.getClassList();

        var tid = parseInt(getQueryStringValue("id") != "" ? getQueryStringValue("id") : "0");
        if (tid > 0) {
            $scope.getSubjectList = function () {

                var obj = {};
                obj.Search = " and sb.subjectid=" + tid;

                $http.post('@Url.Action("Get_subject_List", "Subject")', obj).then(
                                        function (response) {
                                            debugger
                                            $scope.ctrSubjectForm = response.data.aaData[0];
                                            $scope.ClassSelectmodel = _.map(_.where($scope.ctrSubjectForm.Classid.replace(/\s/g, '').split(',')),
                                        function (person) {
                                            return { id: parseInt(person) };
                                        })

                                        },
                                        function (err) {
                                            var error = err;
                                        });
            }
            $scope.getSubjectList();
        }


        $scope.SaveUpdateDeleteSubject = function (Delete) {
            if (!ValidateRequired("subject")) {
                return;
            }
            $scope.ctrSubjectForm.Classid = $scope.ClassSelectmodel.map(function (a) { return a.id; }).join();

            if ($scope.ctrSubjectForm.classid == "") {
                showInfoToast("Please Select Class");
                return
            }


            var obj = {};
            obj.su = $scope.ctrSubjectForm;
            obj.isDelete = Delete;

            $http.post('@Url.Action("SaveUpdate_Delete_Subject", "Subject")', obj).then(
                           function (response) {
                               if (response.data.aaData == 1) {
                                   showSuccessToast("Data Saved Sucessfully");
                                   setTimeout(window.location.href = "@Url.Action("Index", "Subject")", 1000)
                               } else if (response.data.aaData == 2) {
                                   showInfoToast("Already exist Subject Name...");
                               }
                               else {
                                   showWarningToast("Something went wrong.Please Try Again..")
                               };
                           },
                           function (err) {
                               var error = err;
                           });
        }

    });

</script>
